---
links:
  - label: Auth Service
    to: https://jamflow.cloud/auth-service
title: "Auth Module: Server Guide"
description: "JAMflow Authentication and Authorization"
navigation:
  icon: i-lucide-server
---

Jamflow Auth Module ships a set of Nitro utilities that simplify validating sessions, checking permissions, and orchestrating service-to-service calls. This guide covers the helpers you can use inside server routes, server plugins, and event handlers.

::warning
The module is built around JWT validation: it does **not** implement OAuth or OpenID Connect flows. Instead, your Nuxt app proxies to the Jamflow Auth Service endpoints under `/_auth-api/*` and handles tokens issued by that service.
::

## Runtime configuration recap

At runtime the module expects the following properties. They are made available through `useRuntimeConfig(event)`:

- `public.auth.issuer` – Base URL of your Auth Service instance. Used when proxying requests and fetching JWKS keys.
- `public.auth.audience` – Expected audience for access tokens.
- `public.auth.jwksUrl` – Path to retrieve the JSON Web Key Set. Defaults to `/.well-known/jwks.json` relative to the issuer.
- `public.auth.idToken` / `public.auth.accessToken` – Names and verification options for cookies.
- `auth.refreshToken` – Private configuration holding refresh token cookie settings.
- `auth.apiToken` – Optional machine-to-machine token used by `createInvite`.

Use the module options in `nuxt.config.ts` or environment variables to populate these values.

## Session utilities

All session helpers live under the user's identity (ID Token).

### `getUserSession(event)`

Returns the decoded `IDTokenClaims` if a valid cookie is present, or `undefined` otherwise. Cached per-request to avoid repeated verification (eg: when also calling a series of middlewares).

### `requireUserSession(event)`

Same as `getUserSession` but raises a Nitro `createError` with status 401 if the visitor is unauthenticated. Use it in protected API routes:

```ts
import { requireUserSession } from '#auth-module/server/utils/session'

export default defineEventHandler(async (event) => {
  const session = await requireUserSession(event)

  return {
    message: `Welcome ${session.name}`,
  }
})
```

### `clearUserSession(event)`

Deletes ID, access, and refresh token cookies and notifies the Auth Service by issuing a `DELETE /_auth-api/auth/session` request. Ideal for implementing logout endpoints or revoking tokens after destructive events.

The session helper automatically refreshes the user session when a refresh token is nearing expiration. It calls `/api/auth/refresh` and caches the renewed tokens in `event.context.authSessions` to keep future lookups synchronous.

## Access utilities

Access helpers focus on the access token – the one carrying permission strings.

### `getUserAccess(event)` / `requireUserAccess(event)`

Both functions verify the access token using the configured JWKS key set. If the cookie is missing or expired, the module attempts to refresh it via `/_auth-api/auth/token`. The `require*` variant throws a 401 when no valid token can be issued.

### `clearUserAccess(event)`

Deletes the access token by hitting `DELETE /_auth-api/auth/token` and removing the associated cookie.

### `requireUserPermission(event, required)`

Checks whether the current user has all actions listed in `required.actions` for the given topic. It returns a rich object when the check passes:

```ts
const result = await requireUserPermission(event, {
  topic: 'documents',
  actions: ['read', 'update'],
  team: true,          // Force team-scoped permissions
})

// result => {
//   accessToken: AccessTokenClaims,
//   userId: string,
//   teamId: string | null,
//   isGlobal: boolean,
//   selector: string | null,
// }
```

When permissions are missing, a 403 `createError` is thrown. This makes it straightforward to plug into Nitro route middleware.

Under the hood the helper relies on the serialized permissions to match the CRUD operations encoded in the access token.

## Proxy routes

The module exposes two server routes that forward requests to the Auth Service while keeping cookies scoped to your Nuxt domain:

| Route | Target | Use case |
| --- | --- | --- |
| `/_auth-api/**` | `${issuer}/api/**` | Primary login, refresh, logout, and token endpoints.
| `/.well-known/jwks.json` | `${issuer}/.well-known/jwks.json` | Retrieve signing keys for ID/access token verification.

Since these are registered as Nitro handlers, you can call them using `$fetch` within your app without dealing with cross-domain cookies.

## Service utilities

### `createInvite(invite | invite[])`

Helps Jamflow services invite new members via the Auth Service. It accepts either a single invite payload or an array. The helper reads `auth.apiToken` and `public.auth.issuer` from runtime config and performs a POST request to `${issuer}/api/invites`. The return type includes the invite record and the freshly generated plaintext invite token.

Example:

```ts
import { createInvite } from '#auth-module/server/utils/service-utils'

export default defineEventHandler(async (event) => {
  await requireUserPermission(event, {
    topic: 'team-members',
    actions: ['create'],
    team: true,
  })

  const result = await createInvite({
    email: 'alex@example.com',
    teamId: event.context.params!.teamId,
    permissions: ['#team-members:cr'],
  })

  return result
})
```

Make sure `auth.apiToken` is configured with a machine token issued by the Auth Service. Otherwise the helper will throw a 500-level error.

## Error handling patterns

- All `require*` functions throw Nitro errors; wrap them in try/catch if you need to customize the response.
- Token verification logs decoding issues to the server console but fails gracefully by returning `undefined`. Build your handlers assuming that tokens can be absent or invalid.
- Permission checks differentiate between team-scoped (`#`) and global (`@`) grants. Pass `teamId` or `team: true` to enforce the correct scope.

## Related docs

- [Module Overview](/en/auth-module/getting-started.md) – configuration reference and quickstart.
- [Client-side Guide](/en/auth-module/client-guide.md) – using the composables in Vue components.
